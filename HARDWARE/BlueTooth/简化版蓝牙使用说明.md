# 简化版蓝牙阈值控制使用说明

## 系统概述

通过手机蓝牙调试软件发送单个数字来控制MQ-2烟雾传感器的报警阈值。

## 🔧 LCD显示问题诊断

如果LCD没有显示，请按以下步骤检查：

### 1. 硬件连接检查
- **电源**: 确认LCD VDD接5V，VSS接GND
- **对比度**: 调节V0引脚电位器，顺时针/逆时针转动
- **引脚连接**: 确认以下连接正确
  ```
  LCD1602    STM32F407
  VSS   →    GND
  VDD   →    5V
  V0    →    电位器中间端 (两端接5V和GND)
  RS    →    PB0
  EN    →    PB1
  D4    →    PB4
  D5    →    PB5
  D6    →    PB6
  D7    →    PB7
  A     →    5V (背光)
  K     →    GND (背光)
  ```

### 2. 软件调试步骤
1. **使用调试版本**: 编译运行 `main_debug.c`
2. **观察启动过程**: LCD应该依次显示：
   - "LCD Test OK" + "Step 1"
   - "Init MQ-2..." + "Step 2"  
   - "Init Bluetooth" + "Step 3"
   - "System Ready!" + "BT: 1-5,0,9"
3. **检查循环运行**: 应该看到 "Loop:xxxx T:xxx" 不断更新

### 3. 常见问题解决
- **完全无显示**: 检查供电和对比度调节
- **显示乱码**: 检查数据线连接（D4-D7）
- **显示不更新**: 检查EN和RS引脚连接
- **背光不亮**: 检查A和K引脚连接

## 📱 简化蓝牙命令

### 命令列表
| 发送字符 | 功能 | 设置阈值 |
|---------|------|---------|
| `1` | 低敏感度 | 100 ppm |
| `2` | 较低敏感度 | 200 ppm |
| `3` | 标准敏感度 | 300 ppm |
| `4` | 较高敏感度 | 400 ppm |
| `5` | 高敏感度 | 500 ppm |
| `0` | 查询当前阈值 | - |
| `9` | 获取系统状态 | - |

### 使用方法
1. **手机连接蓝牙**: 搜索并连接HC-05/HC-06模块
2. **打开蓝牙调试软件**: 如"蓝牙串口调试助手"
3. **发送单个数字**: 直接输入数字1-5设置阈值

### 示例操作
```
发送: 3
收到: Threshold: 300ppm

发送: 0  
收到: Current: 300ppm

发送: 9
收到: Status request OK
```

## 📺 LCD显示格式

### 正常运行显示
```
第一行: S:xxxx T:yyyy    (烟雾浓度:阈值)
第二行: Status状态       (Normal/Caution/ALARM!!)
```

### 调试模式显示
```
第一行: Loop:xxxx T:yyy  (循环次数:阈值)
第二行: 状态信息         (等待/超时/数值等)
```

## 🔍 故障排除步骤

### Step 1: 基础检查
1. 确认STM32供电正常 (LED指示灯亮)
2. 确认LCD供电正常 (背光应该亮)
3. 调节LCD对比度电位器

### Step 2: 代码测试
1. 编译并下载 `main_debug.c`
2. 观察LCD启动过程
3. 如果Step 1就没显示，重点检查LCD硬件

### Step 3: 蓝牙测试
1. 手机搜索蓝牙设备 (HC-05或HC-06)
2. 配对成功后连接
3. 发送字符 '3'，观察LCD阈值是否变化

### Step 4: 传感器测试
1. 观察LCD是否显示 "Wait:xxx/500"
2. 如果显示 "MQ-2 Timeout!"，检查MQ-2连接
3. 正常情况应显示 "S:数值"

## ⚡ 快速修复建议

### 如果LCD完全不显示
```c
// 在main函数最开始添加简单测试
lcd_init();
lcd_clear();
lcd_print_str(0, 0, "Hello");
lcd_print_str(1, 0, "World");
while(1); // 停在这里观察
```

### 如果蓝牙连接有问题
- 确认波特率设置为9600
- 尝试先发送字符，看蓝牙模块TX灯是否闪烁
- 检查USART2的TX(PA2)和RX(PA3)连接

### 如果程序卡死
- 注释掉MQ2相关代码，只测试LCD和蓝牙
- 使用调试器或LED指示灯确认程序运行位置

## 📋 系统状态说明

### 阈值分级报警
- **Normal**: 烟雾浓度 < 阈值/2
- **Caution**: 阈值/2 ≤ 烟雾浓度 < 阈值  
- **ALARM!!**: 烟雾浓度 ≥ 阈值

### 推荐阈值设置
- **客厅/办公室**: 300ppm (命令: 3)
- **厨房**: 500ppm (命令: 5) - 避免烹饪误报
- **卧室**: 200ppm (命令: 2) - 提高安全性
- **实验室**: 100ppm (命令: 1) - 最高敏感度

通过这种简化的数字命令方式，您可以轻松地通过手机调整不同环境的监测敏感度。
