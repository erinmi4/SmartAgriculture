# 蓝牙阈值控制系统使用说明

## 系统概述

本系统通过蓝牙模块实现对MQ-2烟雾传感器报警阈值的远程控制。用户可以通过手机蓝牙或蓝牙调试工具发送命令来设置和查询烟雾报警阈值。

## 硬件配置

### 蓝牙模块连接 (HC-05/HC-06)
- **VCC** → 3.3V 或 5V
- **GND** → GND
- **TXD** → STM32 PA3 (USART2_RX)
- **RXD** → STM32 PA2 (USART2_TX)

### MQ-2传感器连接
- **VCC** → 5V
- **GND** → GND
- **TXD** → STM32 PB11 (USART3_RX)
- **RXD** → STM32 PB10 (USART3_TX)

### LCD1602显示器
- 按照现有连接方式

## 蓝牙命令格式

### 1. 设置阈值命令
**格式**: `SET_THR:xxx`
**功能**: 设置烟雾报警阈值
**参数**: xxx为阈值数值 (50-2000 ppm)
**示例**:
```
SET_THR:300    // 设置阈值为300ppm
SET_THR:500    // 设置阈值为500ppm
SET_THR:150    // 设置阈值为150ppm
```

**响应**:
```
Threshold set to 300 ppm
```
或
```
Invalid threshold! Range: 50-2000 ppm
```

### 2. 查询阈值命令
**格式**: `GET_THR`
**功能**: 查询当前设置的阈值
**示例**:
```
GET_THR
```

**响应**:
```
Current threshold: 300 ppm
```

### 3. 获取状态命令
**格式**: `GET_STATUS`
**功能**: 获取当前系统状态
**示例**:
```
GET_STATUS
```

**响应**:
```
STATUS: NORMAL
Smoke: 45 ppm
Threshold: 300 ppm
Ratio: 15.0%
```

## LCD显示格式

### 主显示模式
```
第一行: S:xxxx T:yyyy    (S=当前烟雾浓度, T=阈值)
第二行: Status: xxxxxx   (状态显示)
```

### 状态等级
- **Normal**: 烟雾浓度 < 阈值的50%
- **Caution**: 阈值的50% ≤ 烟雾浓度 < 阈值
- **ALARM!!**: 烟雾浓度 ≥ 阈值

### 显示示例
```
S: 120 T: 300
Status: Normal
```

```
S: 280 T: 300
Status: Caution
```

```
S: 350 T: 300
Status: ALARM!!
```

## 使用步骤

### 1. 硬件连接
1. 按照硬件配置连接蓝牙模块、MQ-2传感器和LCD显示器
2. 确保供电正常，连接无误

### 2. 蓝牙配对
1. 给系统上电，等待蓝牙模块初始化
2. 用手机或电脑搜索蓝牙设备 (通常名为HC-05或HC-06)
3. 配对密码通常为 `1234` 或 `0000`

### 3. 连接调试工具
推荐使用以下蓝牙调试工具：
- **Android**: 串口蓝牙调试助手
- **iOS**: LightBlue Explorer
- **PC**: Bluetooth Terminal 或 PuTTY

### 4. 发送命令
1. 连接成功后，系统会发送欢迎信息：
   ```
   Bluetooth Ready
   Commands: SET_THR:xxx, GET_THR, GET_STATUS
   ```

2. 发送命令设置阈值：
   ```
   SET_THR:250
   ```

3. 查询当前设置：
   ```
   GET_THR
   ```

4. 获取实时状态：
   ```
   GET_STATUS
   ```

## 应用场景

### 1. 智能家居
- 根据不同房间调整烟雾报警阈值
- 厨房阈值设置较高避免误报
- 卧室阈值设置较低确保安全

### 2. 工业监控
- 不同工艺环境设置不同阈值
- 远程调整监控参数
- 实时获取环境状态

### 3. 实验教学
- 演示物联网远程控制
- 展示传感器阈值设置
- 蓝牙通信协议学习

## 故障排除

### 1. 蓝牙无法连接
**问题**: 搜索不到蓝牙设备
**解决**:
- 检查蓝牙模块供电是否正常
- 确认蓝牙模块LED指示灯状态
- 重启系统重新搜索

### 2. 命令无响应
**问题**: 发送命令后无反应
**解决**:
- 检查命令格式是否正确
- 确认是否添加了回车换行符
- 验证波特率设置 (9600)

### 3. 阈值设置失败
**问题**: 设置阈值后显示"Invalid threshold"
**解决**:
- 确认阈值范围在50-2000之间
- 检查命令格式: `SET_THR:数字`
- 确认数字格式正确，无多余字符

### 4. 传感器数据异常
**问题**: 烟雾浓度显示异常
**解决**:
- 检查MQ-2传感器连接
- 确认USART3通信正常
- 重启系统重新初始化

## 系统特点

### ✅ 优势
- **远程控制**: 支持蓝牙无线调节阈值
- **实时反馈**: 命令执行立即返回结果
- **多命令支持**: 设置、查询、状态三类命令
- **安全范围**: 阈值限制在合理范围内
- **状态显示**: LCD和蓝牙双重状态反馈

### ✅ 技术特色
- **模块化设计**: 蓝牙功能完全独立封装
- **非阻塞通信**: 蓝牙处理不影响传感器采集
- **多串口管理**: USART2蓝牙 + USART3传感器
- **智能判断**: 根据动态阈值调整报警等级

## 扩展功能

### 可添加功能
1. **历史记录**: 记录阈值修改历史
2. **多用户管理**: 支持不同用户权限
3. **定时任务**: 定时自动调整阈值
4. **数据上传**: 通过蓝牙上传传感器数据
5. **报警推送**: 超阈值时主动推送警报

### 协议扩展
1. **JSON格式**: 使用JSON格式传输数据
2. **加密通信**: 添加简单的数据加密
3. **批量命令**: 支持一次发送多个命令
4. **配置文件**: 支持导入导出配置

## 总结

本蓝牙阈值控制系统成功实现了传感器参数的远程动态调整功能，具有良好的用户体验和系统稳定性。通过标准的蓝牙通信协议，用户可以方便地远程监控和调整环境监测参数，适用于多种实际应用场景。
