# MQ-2烟雾传感器实现说明

## 概述

本项目实现了MQ-2烟雾传感器的数据采集和LCD1602显示功能。**重要：main.c文件中不包含任何底层实现细节，所有底层功能都封装在对应的模块中。**

## 设计原则

**模块化设计原则**：
- ✅ **main.c**：只包含业务逻辑，调用接口函数
- ✅ **mq2.c/mq2.h**：封装所有MQ-2相关底层实现
- ✅ **uart.c**：统一管理串口中断和数据处理
- ✅ **接口清晰**：函数职责明确，易于使用和维护

## 文件结构

```
HARDWARE/MQ/
├── mq2.h              # MQ-2传感器接口头文件
├── mq2.c              # MQ-2传感器实现文件
└── MQ-2实现说明.md    # 本说明文档

USER/stm32f407project/src/
├── main.c              # 主程序文件(只调用接口函数)
└── main_both_sensors.c # DHT11+MQ-2组合使用示例

MiddleWare/UART/
├── uart.c         # UART通信模块(包含MQ2_ProcessData调用)
└── uart.h         # UART通信模块头文件
```

## 接口函数说明

### mq2.h 提供的接口

```c
void MQ2_Init(void);                // MQ-2初始化
void MQ2_SendCommand(void);         // 发送命令到MQ-2传感器
unsigned int MQ2_GetValue(void);    // 获取烟雾浓度值
unsigned char MQ2_IsDataReady(void);// 检查数据是否就绪
void MQ2_ClearFlag(void);           // 清除数据就绪标志
void MQ2_ProcessData(uint8_t ch);   // MQ-2数据处理函数(由uart.c调用)
```

### 使用流程

1. **初始化阶段**：
   ```c
   MQ2_Init();  // 初始化MQ-2传感器和串口通信
   ```

2. **数据采集循环**：
   ```c
   MQ2_ClearFlag();           // 清除上一次的数据标志
   MQ2_SendCommand();         // 发送读取命令
   while(!MQ2_IsDataReady()); // 等待数据就绪
   value = MQ2_GetValue();    // 获取烟雾浓度值
   ```

## 显示格式

### LCD显示内容 (16x2)
```
第一行: Smoke:XXXX ppm    (烟雾浓度显示)
第二行: Status: XXXXX     (状态显示)
```

### 显示示例
**正常状态**:
```
Smoke:  45 ppm
Status: Normal
```

**警告状态**:
```
Smoke: 250 ppm
Status: Low
```

**危险状态**:
```
Smoke: 600 ppm
Status: HIGH!!!
```

## 传感器配置

### MQ-2烟雾传感器
- **接口**: USART3 (PB10-TX, PB11-RX)
- **波特率**: 9600
- **供电**: 5V
- **检测范围**: 300-10000 ppm
- **更新频率**: 2秒

## 通信协议

### 发送命令
```c
unsigned char mq2_cmd[9] = {0xFF, 0x01, 0x86, 0x00, 0x00, 0x00, 0x00, 0x00, 0x79};
```

### 接收数据格式
- **数据长度**: 9字节
- **格式**: [0xFF, 0x01, 高字节, 低字节, ...]
- **烟雾浓度** = 高字节 << 8 | 低字节

## 状态分级

- **Normal**: < 100 ppm (正常)
- **Low**: 100-300 ppm (轻微污染)  
- **Medium**: 300-500 ppm (中等污染)
- **HIGH!!!**: > 500 ppm (严重污染)

## 主要函数

### MQ-2相关函数
- `usart3_init()` - 初始化USART3通信
- `usart_send_str(cmd, len)` - 发送命令到MQ-2传感器
- `MQ2_ProcessData(ch)` - 处理接收到的数据（中断调用）

### 数据处理流程
1. **发送命令**: 通过USART3发送检测命令
2. **等待响应**: 等待mq_flag标志位置1
3. **解析数据**: 从接收缓冲区解析烟雾浓度
4. **显示结果**: 在LCD上显示浓度和状态

## 硬件连接

### MQ-2传感器引脚
- **VCC** → 5V
- **GND** → GND
- **TX** → PB11 (USART3_RX)
- **RX** → PB10 (USART3_TX)

### LCD1602
- 按照lcd.h中的引脚定义连接

## 代码特点

### 1. 完整实现
- 包含完整的MQ-2通信协议
- 使用中断方式接收数据
- 实时数据处理和显示

### 2. 错误处理
- 帧头检测和数据校验
- 超时保护机制
- 状态分级显示

### 3. 用户友好
- 直观的浓度数值显示
- 清晰的状态分级
- 定时自动更新

## 使用方法

1. **硬件连接**: 按照上述引脚定义连接MQ-2和LCD
2. **编译下载**: 编译main.c并下载到STM32F407
3. **运行观察**: 上电后LCD显示烟雾浓度和状态

## 工作流程

1. **系统初始化**: 初始化USART3、LCD等外设
2. **显示启动信息**: "MQ-2 Starting..."
3. **循环检测**: 
   - 发送检测命令
   - 等待传感器响应
   - 解析浓度数据
   - 更新LCD显示
4. **状态判断**: 根据浓度值显示对应状态

## 注意事项

1. **传感器预热**: MQ-2需要预热时间才能提供准确读数
2. **通信稳定**: 确保USART3连接稳定，避免干扰
3. **供电要求**: 确保MQ-2传感器5V供电稳定
4. **检测环境**: 在通风良好的环境中测试

## 故障排除

### 常见问题
1. **显示一直为0**: 
   - 检查MQ-2传感器连接
   - 确认USART3配置正确
   - 检查供电电压

2. **数据不更新**:
   - 检查中断是否正常
   - 确认mq_flag标志位变化
   - 检查串口通信

3. **LCD显示异常**:
   - 检查LCD连接
   - 确认lcd_init()成功执行

## 扩展功能建议

1. **报警功能**: 添加蜂鸣器在高浓度时报警
2. **数据记录**: 保存历史浓度数据
3. **阈值设置**: 可调整的报警阈值
4. **无线传输**: 通过WiFi或蓝牙上传数据
5. **多传感器**: 支持多个环境传感器

这个MQ-2烟雾传感器系统提供了完整的环境烟雾监测解决方案！
