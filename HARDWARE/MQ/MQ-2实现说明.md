# MQ-2烟雾传感器实现说明

## 项目实现

本项目成功实现了MQ-2烟雾传感器的实时监测功能，能够实时获取环境烟雾数据并显示在LCD1602上。

## 文件结构

```
├── USER/stm32f407project/src/main.c    - 主程序文件
├── HARDWARE/MQ/mq2.h                   - MQ-2传感器头文件
├── HARDWARE/MQ/mq2.c                   - MQ-2传感器源文件
└── MiddleWare/UART/uart.c              - 修改的UART模块(支持MQ-2)
```

## 主要功能

### 1. 实时烟雾监测
- 通过USART3与MQ-2传感器通信
- 发送检测命令：`{0xFF, 0x01, 0x86, 0x00, 0x00, 0x00, 0x00, 0x00, 0x79}`
- 接收9字节响应数据
- 解析烟雾浓度值 (ppm)

### 2. LCD显示
- **第一行**: 显示烟雾浓度值 `Smoke:XXXX ppm`
- **第二行**: 显示状态信息
  - `Status: Normal` (< 100 ppm)
  - `Status: Low` (100-300 ppm) 
  - `Status: Medium` (300-500 ppm)
  - `Status: HIGH!!!` (> 500 ppm)

### 3. 模块化设计
- **MQ2模块**: 独立的传感器驱动
- **主程序**: 简洁的业务逻辑
- **UART模块**: 支持MQ-2数据处理

## 关键函数

### MQ2模块 (mq2.c/mq2.h)
- `MQ2_Init()` - 初始化MQ-2传感器和USART3
- `MQ2_SendCommand()` - 发送检测命令
- `MQ2_GetValue()` - 获取烟雾浓度值
- `MQ2_IsDataReady()` - 检查数据是否就绪
- `MQ2_ClearFlag()` - 清除数据就绪标志
- `MQ2_ProcessData()` - 处理接收到的数据

### 主程序 (main.c)
- 系统初始化
- MQ-2传感器初始化  
- LCD初始化
- 主循环：发送命令 → 等待响应 → 显示数据

## 通信协议

### 命令格式
```
发送: FF 01 86 00 00 00 00 00 79
接收: FF 01 HH LL XX XX XX XX CC
```
- `HH LL`: 烟雾浓度高低字节
- 浓度值 = HH << 8 | LL

## 解决的问题

### 1. 重复定义错误
- **问题**: `UART_RxCallback` 在uart.c和main.c中重复定义
- **解决**: 在mq2.c中实现`MQ2_ProcessData()`，在uart.c中调用

### 2. 模块化设计
- **问题**: 原代码全部在main.c中，不利于维护
- **解决**: 分离MQ-2功能到独立模块

### 3. 代码规范
- **问题**: 变量名拼写错误，函数命名不规范
- **解决**: 统一命名规范，添加完整注释

## 使用方法

### 1. 硬件连接
- MQ-2传感器连接到USART3 (PB10-TX, PB11-RX)
- LCD1602按照lcd.h中的定义连接
- 波特率: 9600

### 2. 编译运行
1. 将mq2.c添加到工程编译列表
2. 确保包含路径包含HARDWARE/MQ目录
3. 编译并下载到STM32F407

### 3. 测试验证
- 上电后LCD显示 "MQ-2 Starting..."
- 2秒后开始显示实时烟雾数据
- 在不同烟雾环境中测试状态显示

## 扩展功能建议

1. **报警功能**: 添加蜂鸣器在高浓度时报警
2. **数据记录**: 保存历史数据到FLASH或SD卡
3. **无线传输**: 通过WiFi或蓝牙上传数据
4. **阈值设置**: 可调整的报警阈值
5. **多传感器**: 支持多个MQ系列传感器

## 注意事项

1. **传感器预热**: MQ-2传感器需要预热时间才能提供准确读数
2. **通信稳定性**: 确保串口线路稳定，避免干扰
3. **电源要求**: 确保传感器供电稳定
4. **数据校验**: 可以添加校验和验证数据完整性

## 项目优势

1. **模块化设计**: 代码结构清晰，易于维护
2. **错误处理**: 完善的异常处理机制
3. **实时显示**: 2秒更新一次，响应及时
4. **状态分级**: 四级状态显示，直观易懂
5. **扩展性强**: 易于添加新功能

项目成功解决了重复定义错误，实现了稳定的MQ-2烟雾传感器实时监测系统！
