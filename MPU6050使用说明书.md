# MPU6050使用说明书

## 1. 简介

MPU6050是一款集成了3轴加速度计和3轴陀螺仪的6轴运动传感器。本文档详细说明了在STM32F407智能农业项目中如何使用MPU6050传感器进行姿态检测和角度计算。

## 2. 硬件连接

### 2.1 引脚定义

MPU6050使用I2C总线与STM32进行通信，引脚连接如下：

| MPU6050引脚 | STM32F4引脚 | 功能描述 |
| ---------- | ---------- | ------- |
| VCC        | 3.3V      | 电源     |
| GND        | GND       | 地线     |
| SCL        | PB8       | I2C时钟线 |
| SDA        | PB9       | I2C数据线 |
| INT        | 未连接     | 中断引脚（可选） |

### 2.2 I2C总线连接注意事项

1. 确保I2C总线上拉电阻正常（推荐4.7kΩ）
2. 连线尽量短，避免干扰
3. 如果出现通信不稳定，可尝试在VCC和GND之间并联一个0.1μF的电容

## 3. 软件配置

### 3.1 相关文件

项目中与MPU6050相关的文件包括：

- `mpu6050.h` - MPU6050头文件，包含寄存器定义和函数声明
- `mpu6050.c` - MPU6050源文件，包含初始化和数据读取函数
- `i2c.h/i2c.c` - I2C驱动文件，提供底层通信支持

### 3.2 初始化流程

MPU6050的初始化流程如下：

```c
// 1. 首先初始化I2C总线
My_I2C_Init();

// 2. 唤醒MPU6050
I2C_Write_Byte(MPU6050_ADDR, PWR_MGMT_1, 0x00);

// 3. 设置采样率
I2C_Write_Byte(MPU6050_ADDR, SMPLRT_DIV, 0x07); // 125Hz

// 4. 配置低通滤波器
I2C_Write_Byte(MPU6050_ADDR, CONFIG, 0x00);

// 5. 配置陀螺仪量程 (默认±250°/s)
I2C_Write_Byte(MPU6050_ADDR, GYRO_CONFIG, 0x00);

// 6. 配置加速度计量程 (默认±2g)
I2C_Write_Byte(MPU6050_ADDR, ACCEL_CONFIG, 0x00);

// 7. 使能数据就绪中断
I2C_Write_Byte(MPU6050_ADDR, INT_ENABLE, 0x01);
```

### 3.3 主要寄存器说明

| 寄存器地址 | 名称 | 功能描述 |
| --------- | ---- | ------- |
| 0x6B | PWR_MGMT_1 | 电源管理寄存器1，用于设备复位和电源模式 |
| 0x19 | SMPLRT_DIV | 采样率分频器 |
| 0x1A | CONFIG | 配置寄存器，用于配置外部同步和低通滤波器 |
| 0x1B | GYRO_CONFIG | 陀螺仪配置寄存器，用于设置自测和量程 |
| 0x1C | ACCEL_CONFIG | 加速度计配置寄存器，用于设置自测和量程 |
| 0x3B-0x40 | ACCEL_XOUT_H - ACCEL_ZOUT_L | 加速度计输出寄存器 |
| 0x43-0x48 | GYRO_XOUT_H - GYRO_ZOUT_L | 陀螺仪输出寄存器 |
| 0x41-0x42 | TEMP_OUT_H/TEMP_OUT_L | 温度输出寄存器 |

## 4. 数据获取与处理

### 4.1 读取原始数据

从MPU6050读取原始数据的函数如下：

```c
// 读取加速度数据
void MPU6050_Read_Accel(int16_t *ax, int16_t *ay, int16_t *az)
{
    uint8_t buf[6];
    MPU6050_Read_Multiple(ACCEL_XOUT_H, buf, 6);
    *ax = (buf[0] << 8) | buf[1];
    *ay = (buf[2] << 8) | buf[3];
    *az = (buf[4] << 8) | buf[5];
}

// 读取陀螺仪数据
void MPU6050_Read_Gyro(int16_t *gx, int16_t *gy, int16_t *gz)
{
    uint8_t buf[6];
    MPU6050_Read_Multiple(GYRO_XOUT_H, buf, 6);
    *gx = (buf[0] << 8) | buf[1];
    *gy = (buf[2] << 8) | buf[3];
    *gz = (buf[4] << 8) | buf[5];
}

// 读取温度数据
int16_t MPU6050_Read_Temperature(void)
{
    uint8_t buf[2];
    MPU6050_Read_Multiple(TEMP_OUT_H, buf, 2);
    return (buf[0] << 8) | buf[1];
}
```

### 4.2 数据转换与处理

MPU6050原始数据需要进行转换才能得到实际物理单位的值：

```c
void MPU6050_GetData(MPU6050_Data_t *mpu_data)
{
    int16_t ax, ay, az, gx, gy, gz;
    uint8_t buf[2];
    
    // 读取加速度计数据
    MPU6050_Read_Accel(&ax, &ay, &az);
    
    // 读取陀螺仪数据
    MPU6050_Read_Gyro(&gx, &gy, &gz);
    
    // 读取温度数据
    MPU6050_Read_Multiple(0x41, buf, 2);
    int16_t temp_raw = (buf[0] << 8) | buf[1];
    
    // 转换为物理量
    // 加速度：±2g量程下，16384 LSB/g
    mpu_data->accel_x = (float)ax / 16384.0f; // 单位：g
    mpu_data->accel_y = (float)ay / 16384.0f;
    mpu_data->accel_z = (float)az / 16384.0f;
    
    // 陀螺仪：±250°/s量程下，131 LSB/(°/s)
    mpu_data->gyro_x = (float)gx / 131.0f; // 单位：°/s
    mpu_data->gyro_y = (float)gy / 131.0f;
    mpu_data->gyro_z = (float)gz / 131.0f;
    
    // 温度：温度公式 T = (TEMP_OUT/340) + 36.53
    mpu_data->temp = (float)temp_raw / 340.0f + 36.53f; // 单位：°C
}
```

### 4.3 计算姿态角

基于加速度计数据可以计算出Roll和Pitch角度（使用反正切函数）：

```c
// 计算Roll角度（绕X轴的旋转）
float roll = atan2f(accel_y, accel_z) * 57.29578f; // 转换为角度值

// 计算Pitch角度（绕Y轴的旋转）
float pitch = atan2f(-accel_x, 
           sqrtf(accel_y*accel_y + accel_z*accel_z)) * 57.29578f;
```

### 4.4 数据融合（可选）

在实际应用中，可以使用互补滤波器或卡尔曼滤波器将加速度计和陀螺仪的数据进行融合，以获得更准确的姿态估计：

```c
// 简单互补滤波示例
float alpha = 0.98f;
float dt = 0.01f; // 采样时间间隔
float roll_filtered = alpha * (roll_prev + gyro_x * dt) + (1-alpha) * roll_accel;
float pitch_filtered = alpha * (pitch_prev + gyro_y * dt) + (1-alpha) * pitch_accel;
```

## 5. 使用示例

### 5.1 基本使用流程

```c
// 1. 初始化MPU6050
MPU6050_Init();

// 2. 验证MPU6050是否工作正常
int16_t ax, ay, az;
MPU6050_Read_Accel(&ax, &ay, &az);
if(ax != 0 || ay != 0 || az != 0) {
    // MPU6050工作正常
    sensor_data.mpu_status = 1;
}

// 3. 定期读取MPU6050数据
MPU6050_Data_t mpu_data;
MPU6050_GetData(&mpu_data);

// 4. 计算姿态角
float roll = atan2f(mpu_data.accel_y, mpu_data.accel_z) * 57.29578f;
float pitch = atan2f(-mpu_data.accel_x, 
         sqrtf(mpu_data.accel_y*mpu_data.accel_y + 
              mpu_data.accel_z*mpu_data.accel_z)) * 57.29578f;
```

### 5.2 在项目中的应用

在智能农业项目中，MPU6050用于检测设备姿态，可应用于：

1. 设备倾斜角度监测
2. 运动状态检测
3. 异常震动检测（可用于安全报警）

## 6. 故障排查

### 6.1 通信问题

如果MPU6050通信失败：

1. 检查硬件连接，确保I2C总线连接正确
2. 检查I2C时序，确保时钟速率不超过400kHz
3. 确认MPU6050地址正确（通常是0x68，如果AD0引脚接高电平则是0x69）
4. 使用示波器检查I2C信号波形是否正常

### 6.2 数据异常

如果MPU6050数据异常：

1. 检查传感器是否受到磁场干扰
2. 校准传感器零偏（可记录静止时的偏移量并补偿）
3. 尝试调整低通滤波器参数滤除噪声
4. 检查电源电压稳定性

### 6.3 I2C超时处理

为防止I2C通信卡死，已在I2C驱动中添加了超时处理：

```c
uint32_t timeout = 10000;
while (I2C_GetFlagStatus(I2C1, I2C_FLAG_BUSY) && --timeout);
if (timeout == 0) {
    // 通信超时，退出
    return;
}
```

## 7. 高级应用

### 7.1 中断模式

MPU6050支持中断模式，当有新数据可用时触发中断：

```c
// 启用数据就绪中断
I2C_Write_Byte(MPU6050_ADDR, INT_ENABLE, 0x01);

// 然后配置STM32的外部中断引脚
// 当MPU6050的INT引脚产生中断时，可以及时读取数据
```

### 7.2 DMP功能（数字运动处理器）

MPU6050内置DMP可以直接输出四元数，实现更高精度的姿态解算：

1. 需要下载DMP固件到MPU6050
2. 配置DMP参数
3. 读取DMP输出的四元数数据

### 7.3 低功耗模式

对于电池供电的应用，可以配置MPU6050的低功耗模式：

```c
// 设置循环唤醒模式，周期性唤醒采样
I2C_Write_Byte(MPU6050_ADDR, PWR_MGMT_1, 0x20);
I2C_Write_Byte(MPU6050_ADDR, PWR_MGMT_2, 0x00);
```

## 8. 其他注意事项

1. 初次使用时，建议对传感器进行校准
2. 定期检查I2C通信状态，确保稳定性
3. 在高频振动环境下使用时，可能需要加装减震措施
4. 传感器放置位置应避免强磁场干扰

## 附录：常用参数参考

### 加速度计量程设置

| FS_SEL | 量程 | 灵敏度 |
| ------ | ---- | ----- |
| 0      | ±2g  | 16384 LSB/g |
| 1      | ±4g  | 8192 LSB/g |
| 2      | ±8g  | 4096 LSB/g |
| 3      | ±16g | 2048 LSB/g |

### 陀螺仪量程设置

| FS_SEL | 量程 | 灵敏度 |
| ------ | ---- | ----- |
| 0      | ±250°/s  | 131 LSB/(°/s) |
| 1      | ±500°/s  | 65.5 LSB/(°/s) |
| 2      | ±1000°/s | 32.8 LSB/(°/s) |
| 3      | ±2000°/s | 16.4 LSB/(°/s) |

### 低通滤波器配置

| DLPF_CFG | 加速度计带宽(Hz) | 陀螺仪带宽(Hz) | 采样率(kHz) |
| -------- | --------------- | ------------- | ---------- |
| 0        | 260             | 256           | 8          |
| 1        | 184             | 188           | 1          |
| 2        | 94              | 98            | 1          |
| 3        | 44              | 42            | 1          |
| 4        | 21              | 20            | 1          |
| 5        | 10              | 10            | 1          |
| 6        | 5               | 5             | 1          |
