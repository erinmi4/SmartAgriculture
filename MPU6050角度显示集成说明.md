# MPU6050角度显示集成说明

## 代码合并完成

### 已完成的集成工作

#### 1. **MPU6050核心驱动整合**
- ✅ 更新了 `mpu6050.h` 添加兼容性数据结构 `MPU6050_Data_t`
- ✅ 更新了 `mpu6050.c` 实现完整的传感器读取功能
- ✅ 添加了 `MPU6050_GetData()` 函数兼容原有系统
- ✅ 添加了设备检测和初始化返回值处理

#### 2. **角度显示功能集成**
- ✅ 修复了 `mpu6050_angle_display.h` 中的头文件引用（lcd1602.h → lcd.h）
- ✅ 移除了重复的LCD初始化函数，避免与系统冲突
- ✅ 优化了 `Float_To_String()` 函数，修复负数显示问题
- ✅ 保留了角度计算和显示功能

#### 3. **I2C驱动集成**
- ✅ 使用了你新添加的 `I2C.h` 和 `I2C.c` 驱动
- ✅ 修复了大小写引用问题
- ✅ 确保I2C初始化和通信函数正确调用

#### 4. **主程序集成**
- ✅ 添加了 `mpu6050_angle_display.h` 头文件引用
- ✅ 启用了 `ENABLE_MPU6050` 模块
- ✅ 更新了姿态页面显示逻辑，使用角度显示功能
- ✅ 保持了与原有系统的兼容性

### 新增功能特性

#### **角度显示功能**
- **Roll角度** - 绕纵轴旋转角度（左倾为负，右倾为正）
- **Pitch角度** - 绕横轴旋转角度（抬升为正，下降为负）
- **实时更新** - 在LCD上实时显示角度值
- **数值格式** - 显示格式为 "角度.小数"（如 45.23）

#### **完整传感器数据**
```c
typedef struct {
    float accel_x;     // 加速度X轴 (g)
    float accel_y;     // 加速度Y轴 (g)
    float accel_z;     // 加速度Z轴 (g)
    float gyro_x;      // 陀螺仪X轴 (°/s)
    float gyro_y;      // 陀螺仪Y轴 (°/s)
    float gyro_z;      // 陀螺仪Z轴 (°/s)
    float temp;        // 温度 (°C)
} MPU6050_Data_t;
```

### 使用方法

#### **查看角度显示**
1. 编译并下载程序到开发板
2. 按 **KEY2** 切换到姿态传感器页面
3. LCD将显示：
   ```
   === MPU6050 ===
   Roll:45.23 Pitch:12.34
   ```

#### **角度含义**
- **Roll角** - 设备绕前后轴旋转
  - 向左倾斜：负值（如 -15.45）
  - 向右倾斜：正值（如 +15.45）
  
- **Pitch角** - 设备绕左右轴旋转  
  - 向上抬升：正值（如 +30.12）
  - 向下俯冲：负值（如 -30.12）

#### **蓝牙命令支持**
所有原有蓝牙命令仍然可用：
- `9` - 查询状态（包含MPU6050数据）
- `7` - 测试报警功能
- `8` - 禁用报警
- `0` - 恢复默认设置

### 技术细节

#### **硬件连接**
```
MPU6050  →  STM32F407
VCC      →  3.3V
GND      →  GND  
SCL      →  PB8 (I2C1_SCL)
SDA      →  PB9 (I2C1_SDA)
```

#### **I2C配置**
- 时钟频率：100kHz
- 地址模式：7位地址
- MPU6050地址：0xD0 (写), 0xD1 (读)

#### **传感器配置**
- 加速度计量程：±2g
- 陀螺仪量程：±250°/s
- 采样率：125Hz
- 低通滤波：关闭

### 调试信息

#### **初始化过程**
系统启动时LCD会显示：
```
Smart Agriculture
Starting...
LED OK
KEY OK  
BEEP OK
ADC OK
BT OK
Sensors Init...
MPU6050...
MPU6050 OK      (如果初始化成功)
MPU6050 Failed  (如果初始化失败)
Sensors Ready!
```

#### **故障排除**
1. **显示"MPU6050 Failed"**
   - 检查硬件连接
   - 确认I2C时钟和数据线连接
   - 检查电源供应（3.3V）

2. **角度值异常**
   - 确认传感器水平放置校准
   - 检查是否有机械振动干扰
   - 重新初始化系统

3. **系统卡死**
   - 检查I2C通信是否正常
   - 确认时钟配置正确
   - 重新编译下载程序

### 扩展功能

#### **可添加的功能**
- 角度数据记录和存储
- 姿态变化报警功能
- 蓝牙实时角度数据传输
- 角度校准和零点设置
- 多轴姿态可视化显示

#### **性能优化**
- 当前更新频率：1秒
- 可调整为更高频率（100ms）
- 添加卡尔曼滤波器减少噪声
- 实现姿态融合算法

## 总结

MPU6050角度显示功能已成功集成到智慧农业系统中，保持了与原有系统的完全兼容性。新功能提供了直观的角度显示，可用于设备姿态监测、倾斜报警等应用。
