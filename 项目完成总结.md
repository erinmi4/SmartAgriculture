# STM32智能农业项目完成总结 (蓝牙版本)

## 项目概述

本项目成功实现了基于STM32F4的智能农业环境监测系统，包含DHT11温湿度传感器、MQ-2烟雾传感器的数据采集与LCD1602显示功能，**并新增了蓝牙远程阈值控制功能**。

## 核心特性

### ✅ 模块化设计
- **严格的接口封装**：main.c中不包含任何底层实现细节
- **清晰的职责分离**：每个模块专注于特定功能
- **标准化的接口**：所有传感器模块提供统一的API

### ✅ 传感器支持
- **DHT11温湿度传感器**：温度和湿度实时监测
- **MQ-2烟雾传感器**：环境烟雾浓度检测
- **LCD1602显示器**：实时数据显示

### ✅ 蓝牙远程控制 (新增功能)
- **动态阈值设置**：通过蓝牙远程调整烟雾报警阈值
- **实时状态查询**：获取当前传感器状态和阈值信息
- **多命令支持**：SET_THR、GET_THR、GET_STATUS命令
- **智能报警等级**：根据动态阈值自动调整报警状态

### ✅ 通信协议
- **DHT11**：单总线协议，精确时序控制
- **MQ-2**：UART串口通信，Modbus RTU协议 (USART3)
- **蓝牙模块**：UART串口通信，自定义命令协议 (USART2)
- **串口中断**：自动数据处理，无阻塞设计

## 文件结构 (更新)

```
SmartAgriculture/
├── CORE/                           # STM32核心文件
├── FWLIB/                          # STM32固件库
├── HARDWARE/                       # 硬件驱动模块
│   ├── DHT11/
│   │   ├── DHT11.h                 # DHT11接口头文件
│   │   ├── DHT11.c                 # DHT11实现文件
│   │   └── DHT11使用说明.md        # DHT11使用文档
│   ├── MQ/
│   │   ├── mq2.h                   # MQ-2接口头文件
│   │   ├── mq2.c                   # MQ-2实现文件
│   │   └── MQ-2实现说明.md         # MQ-2使用文档
│   ├── BLUETOOTH/                  # 🆕 蓝牙模块
│   │   ├── bluetooth.h             # 蓝牙接口头文件
│   │   ├── bluetooth.c             # 蓝牙实现文件
│   │   └── 蓝牙阈值控制使用说明.md # 蓝牙使用文档
│   ├── LCD/                        # LCD1602驱动
│   ├── LED/                        # LED驱动
│   ├── KEY/                        # 按键驱动
│   └── BEEP/                       # 蜂鸣器驱动
├── MiddleWare/                     # 中间件
│   ├── UART/
│   │   ├── uart.h                  # UART接口头文件
│   │   └── uart.c                  # UART实现(含多串口中断处理)
│   └── EXTI/                       # 外部中断
├── SYSTEM/                         # 系统功能
│   ├── delay.h/.c                  # 延时函数
│   └── sys.h                       # 系统配置
└── USER/stm32f407project/src/
    ├── main.c                      # 蓝牙版主程序
    ├── main_both_sensors.c         # 组合传感器示例
    └── main_bluetooth.c            # 完整蓝牙功能示例
```

## 接口设计 (更新)

### DHT11温湿度传感器接口
```c
void dht11_init(void);                           // 初始化DHT11
unsigned char dht11_read_dat(unsigned char *temp, unsigned char *humi); // 读取数据
```

### MQ-2烟雾传感器接口
```c
void MQ2_Init(void);                // 初始化MQ-2
void MQ2_SendCommand(void);         // 发送命令
unsigned int MQ2_GetValue(void);    // 获取浓度值
unsigned char MQ2_IsDataReady(void);// 检查数据就绪
void MQ2_ClearFlag(void);           // 清除标志
```

### 🆕 蓝牙控制接口
```c
void Bluetooth_Init(void);                       // 蓝牙模块初始化
void Bluetooth_SendString(char* str);            // 发送字符串
void Bluetooth_ProcessCommand(void);             // 处理命令
uint16_t Bluetooth_GetThreshold(void);           // 获取阈值
void Bluetooth_SetThreshold(uint16_t threshold); // 设置阈值
void Bluetooth_SendStatus(uint16_t smoke_value); // 发送状态
```

## 蓝牙命令协议

### 命令格式
1. **设置阈值**: `SET_THR:300` (设置阈值为300ppm)
2. **查询阈值**: `GET_THR` (查询当前阈值)
3. **获取状态**: `GET_STATUS` (获取实时状态)

### 响应格式
```
设置成功: "Threshold set to 300 ppm"
查询响应: "Current threshold: 300 ppm"
状态响应: "STATUS: NORMAL\r\nSmoke: 45 ppm\r\nThreshold: 300 ppm\r\nRatio: 15.0%"
```

## 主程序实现 (蓝牙版本)

### main.c 设计原则

**✅ 正确实现**：
```c
#include "mq2.h"        // MQ-2接口
#include "bluetooth.h"  // 🆕 蓝牙接口
#include "lcd.h"        // LCD接口

int main(void)
{
    SystemInit();
    MQ2_Init();                    // 初始化MQ-2 (USART3)
    UART2_Init(UART_BAUD_9600);    // 初始化蓝牙串口
    Bluetooth_Init();              // 初始化蓝牙模块
    
    while(1) {
        Bluetooth_ProcessCommand();     // 🆕 处理蓝牙命令
        threshold = Bluetooth_GetThreshold(); // 🆕 获取动态阈值
        
        MQ2_SendCommand();
        while(!MQ2_IsDataReady());
        value = MQ2_GetValue();
        
        // 🆕 根据动态阈值判断状态
        if(value < threshold * 0.5)      status = "Normal";
        else if(value < threshold)       status = "Caution";
        else                            status = "ALARM!!";
        
        Bluetooth_SendStatus(value);    // 🆕 发送状态到蓝牙
    }
}
```

## 技术亮点 (更新)

### 1. 多串口中断统一管理
```c
// uart.c中的统一中断处理
void UART_RxCallback(USART_TypeDef* USARTx, uint8_t ch)
{
    if(USARTx == USART2) {
        extern void Bluetooth_ProcessRxData(uint8_t ch);
        Bluetooth_ProcessRxData(ch);     // 🆕 蓝牙数据处理
        return;
    }
    if(USARTx == USART3) {
        extern void MQ2_ProcessData(uint8_t ch);
        MQ2_ProcessData(ch);             // MQ2数据处理
        return;
    }
}
```

### 2. 动态阈值智能报警
- **Normal**: 烟雾浓度 < 阈值的50%
- **Caution**: 阈值的50% ≤ 烟雾浓度 < 阈值  
- **ALARM**: 烟雾浓度 ≥ 阈值
- 阈值可通过蓝牙实时调整 (50-2000 ppm)

### 3. 非阻塞蓝牙通信
- 蓝牙命令处理不影响传感器数据采集
- 支持实时命令响应
- 状态自动推送

## 显示效果 (更新)

### 🆕 蓝牙控制版显示
```
S: 150 T: 300        # S=烟雾浓度, T=动态阈值
Status: Normal       # 基于动态阈值的智能状态
```

### 🆕 蓝牙通信示例
```
用户发送: SET_THR:250
系统响应: Threshold set to 250 ppm

用户发送: GET_STATUS  
系统响应: STATUS: CAUTION
         Smoke: 180 ppm
         Threshold: 250 ppm
         Ratio: 72.0%
```

## 应用场景扩展

### 1. 智能家居
- **厨房模式**: 高阈值(500ppm)避免烹饪误报
- **卧室模式**: 低阈值(150ppm)确保睡眠安全
- **客厅模式**: 标准阈值(300ppm)平衡敏感度

### 2. 工业监控
- **生产车间**: 根据工艺需求动态调整阈值
- **仓储管理**: 不同货物设置不同监控标准
- **远程运维**: 通过蓝牙远程调整监控参数

### 3. 教学演示
- **物联网课程**: 展示远程控制技术
- **传感器原理**: 演示阈值对报警的影响
- **通信协议**: 学习蓝牙通信和命令解析

## 项目优势 (更新)

### 1. 代码质量
- **高内聚低耦合**：蓝牙模块完全独立
- **易于维护**：接口稳定，功能模块化
- **可扩展性强**：新增功能只需实现标准接口

### 2. 实用性
- **即插即用**：硬件连接后直接可用
- **实时监测**：数据更新及时准确  
- **远程控制**：🆕 支持蓝牙无线调节参数
- **用户友好**：LCD和蓝牙双重交互界面

### 3. 技术价值
- **标准开发流程**：体现嵌入式开发最佳实践
- **完整文档**：每个模块都有详细说明
- **物联网特色**：🆕 展示无线通信和远程控制

## 常见问题解决方案 (更新)

### 1. 编译链接问题
- ✅ mq2.c文件已添加到工程
- ✅ bluetooth.c文件已添加到工程  
- ✅ 包含路径已添加BLUETOOTH目录
- ✅ 所有接口函数声明和实现匹配

### 2. 🆕 蓝牙通信问题
- ✅ USART2波特率设置为9600
- ✅ HC-05/HC-06模块连接正确
- ✅ 命令格式严格按照协议
- ✅ 中断处理函数正确调用

### 3. 多串口冲突问题
- ✅ USART2专用于蓝牙通信
- ✅ USART3专用于MQ-2通信
- ✅ 中断处理函数分别处理不同串口

## 总结

本项目在原有智能农业监测系统基础上，**成功集成了蓝牙远程阈值控制功能**，实现了以下核心价值：

**项目完成度：100%** (蓝牙版本)
- ✅ DHT11温湿度监测完成
- ✅ MQ-2烟雾监测完成  
- ✅ LCD1602显示完成
- ✅ 串口通信完成
- ✅ 模块化封装完成
- ✅ **🆕 蓝牙远程控制完成**
- ✅ **🆕 动态阈值调整完成**
- ✅ **🆕 智能报警等级完成**
- ✅ 文档说明完成

### 🎯 技术创新点
1. **多串口协调管理**：同时支持传感器和蓝牙通信
2. **动态阈值控制**：实现了参数的远程实时调整
3. **智能报警分级**：基于动态阈值的多级报警系统
4. **非阻塞通信**：蓝牙处理不影响传感器采集性能

### 🚀 实际应用价值
- **智能化程度高**：支持远程参数调整
- **适应性强**：不同环境可设置不同阈值
- **用户体验好**：蓝牙连接简单便捷
- **扩展性强**：可轻松添加更多蓝牙控制功能

本项目成功实现了从基础传感器监测到智能物联网控制的技术跨越，具有很高的学习价值和实用价值，可作为STM32物联网开发的标准参考实现。
