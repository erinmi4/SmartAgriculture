# 程序卡死问题排查与解决方案

## 问题现象
- DHT11显示error
- 所有传感器参数都是0且没有变化
- 程序可能在某处卡住

## 可能的卡死原因分析

### 1. 按键处理中的延时问题 ✅ 已修正
**原问题**：
```c
if(Key_Debounce(KEY0_GPIO, KEY0_PIN))
{
    current_page = PAGE_TEMP_HUMID;
    Mdelay_Lib(200); // 这里会卡死200ms
}
```

**解决方案**：
```c
static uint32_t last_key_time = 0;
if(system_tick - last_key_time < 200) return; // 时间防抖
```

### 2. Light_GetValue()中的多次延时 ✅ 已修正
**原问题**：
- 5次采样，每次5ms延时，总共25ms
- 每500ms调用一次，会累积延时

**解决方案**：
```c
// 直接使用单次采样，避免多次延时
sensor_data.light_raw_value = Light_GetRawValue();
sensor_data.light_percent = 100 - (sensor_data.light_raw_value * 100 / 4095);
```

### 3. MPU6050通信可能卡死 ✅ 已修正
**原问题**：
- I2C通信可能出现死锁
- MPU6050_GetData()可能无返回值检查

**解决方案**：
```c
if(sensor_data.mpu_status)
{
    if(MPU6050_GetData(&sensor_data.mpu_data) != 0)
    {
        sensor_data.error_count++; // 失败时只记录错误，不卡死
    }
}
```

### 4. DHT11读取间隔问题 ✅ 已修正
**原问题**：
- DHT11需要2秒间隔，频繁读取会失败

**解决方案**：
```c
static uint32_t last_dht11_read = 0;
if(system_tick - last_dht11_read >= 2000) // 2秒间隔
{
    last_dht11_read = system_tick;
    // 读取DHT11
}
```

## 调试功能增强

### 1. 系统信息页面增强
现在显示更多调试信息：
- 运行时间
- 错误计数  
- 数据更新计数
- 传感器状态(DHT11/光照/MPU6050)

### 2. 调试显示格式
```
System Debug
Time: 123s      // 运行时间

System Debug  
Errors: 5       // 错误计数

System Debug
Updates: 246    // 数据更新次数

System Debug
Status:101      // DHT11/光照/MPU6050状态
```

## 测试步骤

### 第一步：基础功能测试
1. 编译运行修正后的代码
2. 观察LCD是否能正常显示启动信息
3. 观察LED是否闪烁（表示程序在运行）

### 第二步：传感器逐个测试
1. 切换到系统信息页面（按键4）
2. 观察调试信息是否在变化：
   - Time数值是否增加
   - Updates数值是否增加
   - Status中的状态位

### 第三步：数据验证
1. 切换到各个传感器页面
2. 观察数据是否不再是0
3. 手动测试传感器（遮挡光敏电阻、触摸DHT11等）

## 快速诊断方法

### 检查程序是否完全卡死
- **LED0是否闪烁**：如果LED不闪烁，说明主循环卡死
- **LCD显示是否更新**：观察系统信息页面的时间是否增加

### 检查哪个传感器有问题
通过系统信息页面的Status字段：
- 第1位：DHT11状态 (1=正常, 0=异常)
- 第2位：光照传感器状态 (1=正常, 0=异常)  
- 第3位：MPU6050状态 (1=正常, 0=异常)

### 硬件检查清单
如果软件修正后仍有问题：

1. **DHT11硬件**：
   - 数据线连接PE5
   - VCC/GND供电正常
   - 数据线有4.7K上拉电阻

2. **光敏电阻硬件**：
   - 连接PF7 (ADC3_IN5)
   - 分压电路正确

3. **MPU6050硬件**：
   - I2C线连接PB8/PB9
   - VCC/GND供电正常
   - I2C线有上拉电阻

## 预期修正效果

修正后应该看到：
1. **启动时**：正常显示初始化信息和传感器测试结果
2. **运行时**：各页面数据不再是0，且会实时更新
3. **响应性**：按键切换页面响应正常，无卡顿
4. **稳定性**：程序持续运行，不会卡死

如果修正后仍有问题，建议使用调试版本逐步测试各个模块！
