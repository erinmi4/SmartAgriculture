# STM32智慧农业系统调试使用说明

## 当前状态（调试版本）

系统已经进行了大幅简化，移除了可能导致卡死的复杂功能，专注于基础功能的稳定运行。

## 启用的模块

### 基础模块（始终启用）
- ✅ **LCD显示** - 系统状态和数据显示
- ✅ **LED指示灯** - 系统运行和报警指示
- ✅ **按键** - 页面切换功能
- ✅ **蜂鸣器** - 报警提示
- ✅ **ADC** - 模拟信号采集
- ✅ **光敏电阻** - 环境光照检测

### 通信模块
- ✅ **蓝牙** - 远程命令控制（已简化）

### 传感器模块
- ❌ **DHT11** - 温湿度传感器（已禁用）
- ✅ **MPU6050** - 姿态传感器（已启用，包含角度显示功能）
- ❌ **MQ2** - 烟雾传感器（已禁用）
- ❌ **呼吸灯** - LED呼吸效果（已禁用）

## 主要改进

### 1. 系统初始化优化
- 移除了复杂的启动消息发送
- 简化了传感器初始化流程
- 降低了初始化延时时间
- 添加了详细的LCD状态显示

### 2. 蓝牙功能优化
- 移除了启动时的蓝牙消息发送（避免阻塞）
- 注释了心跳包功能（减少资源占用）
- 降低了蓝牙检查频率（50ms一次）
- 简化了命令处理流程

### 3. 数据采集优化
- 降低了传感器读取频率（1秒一次）
- 简化了MQ2传感器等待逻辑
- 减少了DHT11读取频率（3秒一次）
- 使用默认值替代禁用的传感器

### 4. 主循环优化
- 移除了高频率的LED闪烁
- 简化了循环逻辑
- 降低了系统负载

## 使用方法

### 按键功能
- **KEY0** - 切换到温湿度页面
- **KEY1** - 切换到光照烟雾页面
- **KEY2** - 切换到姿态传感器页面
- **KEY3** - 切换到蓝牙状态页面
- **KEY2+KEY3** - 切换到系统信息页面

### 蓝牙命令（简化版）
发送单个数字命令：
- `1` - 设置温度高阈值为35℃
- `2` - 设置温度低阈值为15℃
- `3` - 设置湿度高阈值为80%
- `4` - 设置湿度低阈值为30%
- `5` - 设置光照低阈值为30%
- `6` - 设置烟雾高阈值为200ppm
- `7` - 启用报警并测试
- `8` - 禁用所有报警
- `9` - 查询当前状态
- `0` - 恢复默认阈值

## 调试步骤

### 第一步：确认基础功能
1. 上电后LCD应该显示启动信息
2. 系统应该能正常初始化到"Sensors Ready!"
3. LED0每2秒闪烁一次表示系统正常运行
4. 按键可以正常切换页面

### 第二步：测试蓝牙功能
1. 连接蓝牙设备
2. 发送命令 `9` 查询状态
3. 系统应该回复当前传感器数据

### 第三步：逐步启用传感器
如果基础功能正常，可以逐步修改main.c中的宏定义启用传感器：
```c
#define ENABLE_DHT11       1    // 启用DHT11
#define ENABLE_MPU6050     1    // 已启用MPU6050（包含角度显示）
#define ENABLE_MQ2         1    // 启用MQ2
```

### 第四步：测试MPU6050角度显示
1. 按KEY2切换到姿态传感器页面
2. 应该看到类似显示：
   ```
   === MPU6050 ===
   Roll:0.00 Pitch:0.00
   ```
3. 倾斜开发板测试角度变化
4. Roll角：左倾为负，右倾为正
5. Pitch角：抬升为正，下降为负

## 故障排除

### 1. LCD不显示
- 检查LCD硬件连接
- 确认LCD初始化代码正确
- 检查电源供应

### 2. 系统卡死
- 检查SysTick配置
- 确认没有死循环
- 检查中断优先级设置

### 3. 蓝牙无响应
- 检查UART2配置
- 确认蓝牙模块工作正常
- 检查波特率设置（9600）

### 4. 传感器数据异常
- 逐个启用传感器测试
- 检查传感器硬件连接
- 确认I2C/SPI通信正常

## 性能监控

系统信息页面显示：
- 运行时间（秒）
- 错误计数
- 传感器状态
- MQ2数据就绪状态

## 下一步计划

1. 确认基础功能稳定
2. 逐步启用DHT11传感器
3. 启用MPU6050姿态传感器  
4. 启用MQ2烟雾传感器
5. 恢复呼吸灯效果
6. 优化蓝牙心跳包功能
7. 添加更多扩展功能
