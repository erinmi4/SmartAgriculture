# main.c 智能农业监测系统实现说明

## 功能概述
本系统是基于STM32F407的智能农业监测系统，集成了多种传感器，实现了数据采集、显示、报警等功能。

## 系统架构

### 全局变量定义
1. **页面管理**
   - `current_page`: 当前显示页面
   - `page_switch_timer`: 页面切换计时器
   - `system_tick`: 系统运行时钟

2. **传感器数据结构 (SensorData_t)**
   - 温湿度数据 (DHT11)
   - 光照/烟雾数据 (ADC)
   - MPU6050姿态数据
   - 系统状态信息

3. **报警阈值设置 (AlarmThresholds_t)**
   - 温度上下限: 10°C - 35°C
   - 湿度上下限: 30% - 80%
   - 光照下限: 200
   - 烟雾上限: 3000

4. **报警状态 (AlarmStatus_t)**
   - 各传感器报警标志
   - 系统报警标志

## 主要功能模块

### 1. 系统初始化 (System_Init)
- 基础系统配置
- 中断优先级分组
- 外设初始化顺序:
  - 延时模块
  - LED和蜂鸣器
  - LCD显示屏
  - ADC模块
- 启动信息显示

### 2. 传感器初始化 (Sensors_Init)
- DHT11温湿度传感器
- 光敏电阻
- MPU6050三轴陀螺仪加速度计
- 初始化状态反馈和错误计数

### 3. 多页面显示系统
支持以下页面类型:
- **PAGE_STARTUP**: 启动页面
- **PAGE_SYSTEM_INFO**: 系统信息(运行时间等)
- **PAGE_TEMP_HUMID**: 温湿度数据
- **PAGE_LIGHT_SMOKE**: 光照/烟雾数据
- **PAGE_ATTITUDE**: MPU6050姿态数据
- **PAGE_ALARM**: 报警页面

### 4. 数据采集 (Update_SensorData)
- 每500ms更新一次传感器数据
- DHT11温湿度读取
- 光照强度ADC采集
- 烟雾浓度ADC采集 (通道5)
- MPU6050加速度和陀螺仪数据
- 自动报警检查

### 5. 报警系统
#### 报警条件检查 (Check_Alarms)
- 温度超出设定范围
- 湿度超出设定范围
- 光照不足
- 烟雾浓度过高
- 系统错误累计过多

#### 报警处理 (Handle_Alarms)
- LED闪烁指示
- 蜂鸣器间歇鸣叫
- 自动切换到报警页面

### 6. 页面自动切换
- 无报警时每3秒自动切换页面
- 有报警时锁定报警页面
- 循环显示各类传感器数据

## 启动流程
1. **系统欢迎信息**
   ```
   Smart Agriculture
   System V1.0
   
   STM32F407 Based
   Multi-Sensor
   ```

2. **初始化过程显示**
   ```
   Sensor Init...
   DHT11...
   Light...
   MPU6050...
   
   Init Complete
   Status: 0x01
   ```

## 运行时显示示例

### 温湿度页面
```
Temp & Humidity
T:25°C H:65%
```

### 光照/烟雾页面
```
Light & Smoke
L:75% S:12%
```

### 姿态页面
```
MPU6050 Attitude
X:0.1g Y:-0.2g
```

### 报警页面
```
!!! ALARM !!!
Temperature!
```

## 硬件接口配置

### I2C接口 (MPU6050)
- SCL: PB8
- SDA: PB9
- 频率: 100kHz
- 使用硬件I2C1外设

### ADC接口
- 光敏电阻: ADC3 通道(根据light.c配置)
- 烟雾传感器: ADC3 通道5

### 显示接口
- LCD1602并行接口

### 指示接口
- LED0: PF9 (报警指示)
- 蜂鸣器: PF8 (报警声音)

## 代码特点
1. **模块化设计**: 每个功能独立封装
2. **错误处理**: 完善的错误计数和状态反馈
3. **用户友好**: 直观的LCD显示和报警提示
4. **可扩展性**: 易于添加新的传感器和页面
5. **稳定性**: 充分的延时和状态检查

## 性能指标
- 系统时钟: 1ms精度
- 数据更新频率: 500ms
- 页面切换周期: 3秒(无报警时)
- 报警响应: 实时
- 内存使用: 优化的全局变量结构

## 扩展建议
1. 可添加按键控制手动切换页面
2. 可增加数据存储和历史记录功能
3. 可添加蓝牙/WiFi通信模块
4. 可实现阈值参数的动态配置
5. 可增加更多类型的传感器支持

这个实现为智能农业监测提供了一个完整、稳定、可扩展的基础平台。
