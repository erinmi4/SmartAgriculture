# STM32智能农业项目 - 使用指南

## 项目概述
这是一个基于STM32F407的智能农业环境监测系统，集成了多种传感器、LCD显示、蓝牙控制和智能报警功能。

## 🚀 快速开始

### 1. 环境准备
确保您已安装以下工具：
- **ARM GCC工具链**: arm-none-eabi-gcc
- **STM32 ST-LINK工具**: 用于程序下载
- **VS Code**: 推荐的开发环境

### 2. 检查工具链
在VS Code中按 `Ctrl+Shift+P`，输入 "Tasks: Run Task"，选择 **"Check ARM Toolchain"** 检查编译环境。

### 3. 编译项目
- 使用快捷键 `Ctrl+Shift+P` → "Tasks: Run Build Task"
- 或直接按 `Ctrl+Shift+B` 编译项目

## 📋 功能特性

### 传感器模块
- **DHT11**: 温湿度检测 (可通过 `ENABLE_DHT11` 开关控制)
- **光敏电阻**: 环境光照检测 (可通过 `ENABLE_LIGHT` 开关控制)  
- **MQ-2**: 烟雾浓度检测 (可通过 `ENABLE_MQ2` 开关控制)
- **MPU6050**: 姿态检测 (可通过 `ENABLE_MPU6050` 开关控制)

### 显示与交互
- **LCD1602**: 多页面数据显示
- **4个按键**: 页面切换控制
- **系统信息页**: 调试信息显示

### 智能报警系统
- **4色LED指示**: 
  - LED0 (PF9): 烟雾报警指示
  - LED1 (PF10): 温度报警指示  
  - LED2 (PE13): 湿度报警指示 + 呼吸灯效果
  - LED3 (PE14): 光照报警指示 + 呼吸灯效果
- **蜂鸣器报警**: 支持普通蜂鸣和音乐报警两种模式
- **呼吸灯效果**: LED2和LED3支持PWM呼吸灯

### 蓝牙远程控制
通过蓝牙发送参数化命令动态调整报警阈值：
- `TH:30` - 设置温度高阈值为30°C
- `TL:15` - 设置温度低阈值为15°C  
- `HH:80` - 设置湿度高阈值为80%
- `HL:30` - 设置湿度低阈值为30%
- `LL:20` - 设置光照低阈值为20%
- `SH:150` - 设置烟雾高阈值为150ppm

## ⚙️ 调试开关配置

在 `main.c` 顶部修改以下宏定义来控制功能模块：

```c
#define ENABLE_DHT11       1    // DHT11温湿度传感器
#define ENABLE_MPU6050     0    // MPU6050姿态传感器 (默认关闭)
#define ENABLE_MQ2         1    // MQ2烟雾传感器
#define ENABLE_LIGHT       1    // 光敏电阻传感器
#define ENABLE_BLUETOOTH   1    // 蓝牙功能
#define ENABLE_BREATHING   1    // 呼吸灯功能
#define ENABLE_MUSIC_BEEP  1    // 音乐蜂鸣器 (0=普通蜂鸣器)
#define ENABLE_ALARM       1    // 报警功能总开关
```

## 🔧 故障排除

### 程序卡死问题
如果程序运行时出现卡死，请按以下步骤排查：

1. **逐个禁用传感器**:
   ```c
   #define ENABLE_DHT11       0    // 先禁用DHT11
   #define ENABLE_MPU6050     0    // 已默认禁用
   #define ENABLE_MQ2         0    // 禁用MQ2测试
   #define ENABLE_LIGHT       0    // 禁用光敏电阻测试
   ```

2. **禁用蓝牙功能**:
   ```c
   #define ENABLE_BLUETOOTH   0
   ```

3. **查看系统信息页**: 按键切换到系统信息页面，查看错误计数和调试信息

### 传感器读取异常
- **DHT11读取失败**: 检查接线和时序，查看系统信息页面的错误计数
- **光敏电阻一直为0**: 已修复，使用 `Light_GetValue()` 函数
- **MQ-2无数据**: 检查UART3配置和接线

### 蓝牙连接问题
- 确保蓝牙模块正确连接到UART2 (PA2/PA3)
- 波特率设置为9600
- 发送命令格式: "CMD:VALUE"

## 📱 蓝牙使用示例

1. **连接蓝牙模块** (通常名称为HC-05或类似)
2. **发送阈值设置命令**:
   - 发送: `TH:35` 
   - 接收: `TH: 35C` (LCD同时显示2秒)
3. **实时监控**: 当传感器数值超过阈值时，系统自动报警

## 📊 LCD页面说明

- **Page 1**: 温度和湿度显示
- **Page 2**: 光照和烟雾浓度显示  
- **Page 3**: MPU6050姿态数据 (如果启用)
- **Page 4**: 系统信息和调试数据

## 🔄 编译和下载

1. **编译**: `Ctrl+Shift+B` 或使用 "Build STM32 Project" 任务
2. **清理**: 使用 "Clean Build" 任务清理编译文件
3. **下载**: 使用ST-LINK工具将生成的.hex文件下载到开发板

## 📝 注意事项

- 系统默认禁用MPU6050以避免卡死问题
- 蓝牙命令修改阈值后会在LCD上显示2秒确认信息 (英文)
- 报警时LED指示灯和呼吸灯会联动工作
- 音乐蜂鸣器支持自定义报警音 (可扩展)

## 🆘 技术支持

如遇到问题，请参考项目中的相关文档：
- `蓝牙参数化命令使用说明.md`
- `系统功能增强总结.md`  
- `程序卡死问题排查方案.md`
