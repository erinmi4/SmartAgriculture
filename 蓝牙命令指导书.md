# STM32智能农业系统 - 蓝牙命令指导书

## 概述

本系统支持通过蓝牙串口远程监控和控制智能农业系统的各项传感器阈值。系统使用标准的AT蓝牙模块，通过UART2接口与STM32主控板通信。

## 硬件连接

### 蓝牙模块连接
- **VCC**: 连接到3.3V或5V电源
- **GND**: 连接到系统地线
- **TXD**: 连接到STM32的PA3 (USART2_RX)
- **RXD**: 连接到STM32的PA2 (USART2_TX)

### 通信参数
- **波特率**: 9600 bps
- **数据位**: 8位
- **停止位**: 1位
- **奇偶校验**: 无
- **流控制**: 无

## 命令格式

### 基本格式
所有命令采用两位数字格式，参数用空格分隔：
```
CMD [VALUE]
```

### 命令列表

| 命令代码 | 功能描述 | 格式 | 示例 | 参数范围 |
|---------|---------|------|------|----------|
| `00` | 查询系统状态 | `00` | `00` | 无参数 |
| `01` | 设置温度高阈值 | `01 VALUE` | `01 30` | 0-60°C |
| `02` | 设置温度低阈值 | `02 VALUE` | `02 15` | 0-60°C |
| `03` | 设置湿度高阈值 | `03 VALUE` | `03 80` | 0-100% |
| `04` | 设置湿度低阈值 | `04 VALUE` | `04 30` | 0-100% |
| `05` | 设置光照低阈值 | `05 VALUE` | `05 20` | 0-100% |
| `06` | 设置烟雾高阈值 | `06 VALUE` | `06 150` | 0-1000ppm |

## 详细命令说明

### 1. 系统状态查询 (00)
**功能**: 查询当前所有传感器数据和报警状态

**命令**: `00`

**响应示例**:
```
=== SYSTEM STATUS ===
Temp: 25°C (20-29)
Humidity: 65% (40-70)
Light: 45% (>40)
Smoke: 45ppm (<120)
Alarms: NONE
Uptime: 1234s, Errors: 0
===================
```

**响应字段说明**:
- `Temp`: 当前温度及阈值范围 (低阈值-高阈值)
- `Humidity`: 当前湿度及阈值范围
- `Light`: 当前光照强度及低阈值
- `Smoke`: 当前烟雾浓度及高阈值
- `Alarms`: 当前报警状态 (NONE表示无报警)
- `Uptime`: 系统运行时间
- `Errors`: 传感器错误计数

### 2. 温度阈值设置 (01/02)

#### 设置温度高阈值 (01)
**功能**: 设置温度过高报警阈值

**命令**: `01 VALUE`

**示例**: `01 35` (设置温度高阈值为35°C)

**成功响应**: `OK: Temp High = 35°C`

**错误响应**: `ERR: Range 0-60°C`

#### 设置温度低阈值 (02)
**功能**: 设置温度过低报警阈值

**命令**: `02 VALUE`

**示例**: `02 10` (设置温度低阈值为10°C)

**成功响应**: `OK: Temp Low = 10°C`

**错误响应**: `ERR: Range 0-60°C`

### 3. 湿度阈值设置 (03/04)

#### 设置湿度高阈值 (03)
**功能**: 设置湿度过高报警阈值

**命令**: `03 VALUE`

**示例**: `03 85` (设置湿度高阈值为85%)

**成功响应**: `OK: Humidity High = 85%`

**错误响应**: `ERR: Range 0-100%`

#### 设置湿度低阈值 (04)
**功能**: 设置湿度过低报警阈值

**命令**: `04 VALUE`

**示例**: `04 25` (设置湿度低阈值为25%)

**成功响应**: `OK: Humidity Low = 25%`

**错误响应**: `ERR: Range 0-100%`

### 4. 光照阈值设置 (05)
**功能**: 设置光照不足报警阈值

**命令**: `05 VALUE`

**示例**: `05 30` (设置光照低阈值为30%)

**成功响应**: `OK: Light Low = 30%`

**错误响应**: `ERR: Range 0-100%`

**说明**: 当光照强度低于设定值时触发报警

### 5. 烟雾阈值设置 (06)
**功能**: 设置烟雾浓度过高报警阈值

**命令**: `06 VALUE`

**示例**: `06 200` (设置烟雾高阈值为200ppm)

**成功响应**: `OK: Smoke High = 200ppm`

**错误响应**: `ERR: Range 0-1000ppm`

**说明**: 当烟雾浓度超过设定值时触发报警

## 报警状态说明

当传感器数值超出设定阈值时，系统会触发相应报警：

### 报警类型
- `T-HIGH`: 温度过高
- `T-LOW`: 温度过低  
- `H-HIGH`: 湿度过高
- `H-LOW`: 湿度过低
- `L-LOW`: 光照不足
- `S-HIGH`: 烟雾浓度过高

### 报警响应
1. **蜂鸣器报警**: 任何报警触发时蜂鸣器会短暂响起
2. **LCD显示**: 在对应页面显示报警标识
3. **蓝牙通知**: 状态查询时会显示当前报警

## 使用示例

### 场景1: 温室环境监控
```bash
# 查询当前状态
00
# 响应: 温度28°C，湿度75%，需要调整阈值

# 提高温度上限到32°C (夏季设置)
01 32
# 响应: OK: Temp High = 32°C

# 降低湿度上限到70% (防止霉菌)
03 70  
# 响应: OK: Humidity High = 70%

# 再次查询确认设置
00
```

### 场景2: 烟雾监测调整
```bash
# 查询当前烟雾状态
00
# 发现烟雾值接近阈值，需要调整灵敏度

# 降低烟雾报警阈值提高灵敏度
06 80
# 响应: OK: Smoke High = 80ppm

# 验证设置
00
```

### 场景3: 光照补偿设置
```bash
# 冬季光照不足，调整阈值
05 60
# 响应: OK: Light Low = 60%

# 查询确认
00
```

## 错误处理

### 常见错误及处理

1. **命令格式错误**
   - 错误: `1 30` (命令不足两位)
   - 响应: `ERR: Invalid format`
   - 正确: `01 30`

2. **参数超出范围**
   - 错误: `01 70` (温度超过60°C)
   - 响应: `ERR: Range 0-60°C`
   - 正确: `01 50`

3. **缺少参数**
   - 错误: `01` (设置命令缺少数值)
   - 响应: `ERR: Command needs value`
   - 正确: `01 30`

4. **未知命令**
   - 错误: `07 100` (不存在的命令)
   - 响应: `ERR: Unknown command '07'`

## 系统默认阈值

| 参数 | 默认值 | 单位 |
|------|--------|------|
| 温度高阈值 | 29 | °C |
| 温度低阈值 | 20 | °C |
| 湿度高阈值 | 70 | % |
| 湿度低阈值 | 40 | % |
| 光照低阈值 | 40 | % |
| 烟雾高阈值 | 120 | ppm |

## 技术说明

### 数据更新频率
- 传感器数据每500ms更新一次
- 蓝牙状态每50ms检查一次
- LCD显示实时更新

### 数据持久性
- 阈值设置在系统运行期间保持有效
- 系统重启后恢复为默认值
- 如需永久保存，需要修改代码中的默认值宏定义

### 通信协议
- 命令以回车换行符结束 (`\r\n`)
- 支持命令回显确认
- 所有响应包含状态提示符 `>>>` 

## 故障排除

### 蓝牙连接问题
1. 检查硬件连接是否正确
2. 确认波特率设置为9600
3. 验证蓝牙模块电源供应

### 命令无响应
1. 检查命令格式是否正确
2. 确认命令以回车结束
3. 查看系统错误计数是否增加

### 传感器数据异常
1. 使用状态查询命令 `00` 检查错误计数
2. 重启系统重新初始化传感器
3. 检查传感器硬件连接

## 版本信息

- **版本**: v1.0
- **更新日期**: 2025年7月2日
- **兼容硬件**: STM32F407开发板
- **支持传感器**: DHT11, MQ-2, 光敏电阻, MPU6050

---

*如有技术问题，请参考源码注释或联系开发团队。*
