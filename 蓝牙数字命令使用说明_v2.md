# STM32智慧农业系统 - 蓝牙数字命令使用说明 v2.0

## 命令概述
系统支持0-9数字命令，通过蓝牙模块可以远程控制阈值设置和报警管理。

## ⚠️ 重要更新
**v2.0版本修复了命令8不能关闭蜂鸣器的问题**

## 命令列表

### 阈值设置命令（1-6）
这些命令会**自动重新启用报警功能**：

- **命令1**: 设置温度高阈值为35℃
- **命令2**: 设置温度低阈值为15℃  
- **命令3**: 设置湿度高阈值为80%
- **命令4**: 设置湿度低阈值为30%
- **命令5**: 设置光照低阈值为30%
- **命令6**: 设置烟雾高阈值为200ppm

### 报警控制命令（7-8）

- **命令7**: **重新启用报警** + 强制触发报警测试
  - 如果之前使用命令8禁用了报警，此命令会重新启用
  - 同时强制触发一个温度报警用于测试蜂鸣器
  
- **命令8**: **彻底禁用所有报警** ⭐️ 已修复
  - 设置报警禁用标志，阻止`Alarm_Check()`重新触发报警
  - 立即关闭蜂鸣器，即使传感器数据超出阈值也不会报警
  - 所有LED报警指示灯关闭
  - **现在可以真正关闭蜂鸣器了！**

### 系统控制命令（9、0）

- **命令9**: 查询当前状态
  - 返回所有传感器数值、阈值设置、报警状态和禁用状态
  - 格式：`STATUS: T=温度(低-高) H=湿度(低-高) L=光照(阈值) S=烟雾(阈值) A=报警状态 D=禁用状态`

- **命令0**: 恢复默认阈值并重新启用报警
  - 所有阈值恢复到程序中定义的默认值
  - 重新启用报警功能

## 使用示例

### 基本阈值设置
```
发送: 1
接收: RECEIVED CMD: 1
      SUCCESS: TempHigh=35C
      COMPLETE
LCD显示: TempHigh: 35C (2秒)
```

### 禁用报警场景 ⭐️ 新功能
```
发送: 8
接收: RECEIVED CMD: 8  
      SUCCESS: All Alarms OFF (Disabled)
      COMPLETE
LCD显示: Alarms DISABLED (2秒)
系统效果: 蜂鸣器立即关闭，即使温度超出阈值也不会再报警
```

### 重新启用报警
```
发送: 7
接收: RECEIVED CMD: 7
      SUCCESS: Alarm ENABLED & Test ON  
      COMPLETE
LCD显示: Alarm ENABLED (2秒)
系统效果: 报警功能重新启用，蜂鸣器开始响起（测试报警）
```

### 状态查询 ⭐️ 增强显示
```
发送: 9
接收: STATUS: T=25C(15-35) H=60%(30-80) L=50%(30) S=45ppm(200) A=NO D=NO
说明: 温度25℃正常, 湿度60%正常, 光照50%正常, 烟雾45ppm正常, 无报警, 报警未禁用
```

## 心跳包 ⭐️ 增强信息
系统每10秒自动发送心跳包：
```
HEARTBEAT: T=25C H=60% S=45ppm Tick=12345 AlarmDisabled=NO
```

## 报警禁用机制详解

### 问题原因
之前命令8只是清零报警状态，但主循环中的`Alarm_Check()`函数会持续检查传感器数据，如果数据仍超出阈值，报警状态会立即被重新设置，导致蜂鸣器又响起。

### 解决方案
新增`alarm_disabled`全局标志：
- 命令8执行时：`alarm_disabled = 1`，`Alarm_Check()`直接返回，不检查传感器数据
- 命令1-7、0执行时：`alarm_disabled = 0`，恢复正常报警检查

### 代码逻辑
```c
void Alarm_Check(void)
{
    if(alarm_disabled)
    {
        // 清除所有报警状态并关闭蜂鸣器
        alarm_status.any_alarm = 0;
        Beep_Off();
        return;  // 直接返回，不进行传感器检查
    }
    
    // 正常的传感器数据检查和报警逻辑
    // ...
}
```

## 调试建议

1. **测试报警功能**: 发送命令7，应该听到蜂鸣器响起
2. **测试禁用功能**: 发送命令8，蜂鸣器应该立即关闭 ⭐️
3. **测试阈值设置**: 发送命令1-6，然后发送命令9查看是否设置成功
4. **监控心跳包**: 每10秒应该收到一次HEARTBEAT消息，确认蓝牙通信正常 ⭐️

## 常见问题

### Q: 命令8执行后蜂鸣器还在响？
A: ⭐️ v2.0版本已修复此问题。如果仍有问题，检查硬件连接和`Beep_Off()`函数实现

### Q: 心跳包没有数据？
A: ⭐️ v2.0版本增强了心跳包信息。检查蓝牙连接、UART2初始化、`Bluetooth_SendString()`函数实现

### Q: 设置阈值后没有生效？
A: 发送命令9查询状态，确认阈值是否设置成功

## 技术细节

- 波特率: 9600
- 数据位: 8
- 停止位: 1  
- 校验位: 无
- 命令格式: 单个数字字符 + 回车换行
- 反馈格式: 多行文本，包含RECEIVED、SUCCESS、COMPLETE确认

## 版本更新记录

### v2.0 (当前版本)
- ⭐️ 修复命令8不能关闭蜂鸣器的问题
- ⭐️ 增加报警禁用机制，彻底阻止报警重新触发
- ⭐️ 增强心跳包信息，包含系统时钟和禁用状态
- ⭐️ 所有阈值设置命令(1-6)自动重新启用报警
- ⭐️ 命令9增加禁用状态显示

### v1.0 
- 基础数字命令系统
- 简单的阈值设置和报警控制
